<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery-1.2.6.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.progressbar.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/json2.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.acts_as_tree_table.js"></script>
        
        <script>
            $(document).ready(function() {
                $('table[id^=taskstable-]').acts_as_tree_table({default_state:'collapsed'});

                $('span.complete').hide();
                $('span.progressbar').hide();
                $('span.progressbar').progressBar({barImage: 'http://doors.osuosl.org/media/images/progressbg_yellow.gif', boxImage:'http://doors.osuosl.org/media/images/progressbar.gif'});

                $('.button-start').click(function(evt) {
                    $.post('start/', {'key':evt.target.parentNode.id});
                });

                // AUTO UPDATES ARE DISABLED
                //update();
            });

            var STATUS_FAILED = -1;
            var STATUS_STOPPED = 0;
            var STATUS_RUNNING = 1;
            var STATUS_PAUSED = 2;
            var STATUS_COMPLETE = 3;

            var CLASS_FAILED = 'status-failed';
            var CLASS_STOPPED = 'status-stopped';
            var CLASS_RUNNING = 'status-running';
            var CLASS_PAUSED = 'status-paused';
            var CLASS_COMPLETE = 'status-complete';

            function removeAllStatus(node){
                node.removeClass(CLASS_FAILED);
                node.removeClass(CLASS_STOPPED);
                node.removeClass(CLASS_RUNNING);
                node.removeClass(CLASS_PAUSED);
                node.removeClass(CLASS_COMPLETE);
            }

            function processProgressData(incommingJSON) {
                statusMessage = JSON.parse(incommingJSON);
                for (key in statusMessage){
                    progressArray = statusMessage[key]['status'];

                    for (i=0; i<progressArray.length; i++){
                        // store array as vars for readability
                        id          = progressArray[i]['id'];
                        status      = progressArray[i]['status'];
                        progress    = progressArray[i]['progress'];
                        msg         = progressArray[i]['msg'];

                        taskSelectString = '#'+key+' #task-' + key + '-' + id
                        elt = $(taskSelectString);
                        // check status and update if needed
                        if (status == STATUS_STOPPED && !elt.hasClass(CLASS_STOPPED)) {
                            // hide progress bar 
                            if (elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED)) {
                                $(taskSelectString + ' span.progressbar').hide()
                            }
                            //hide completion message
                            if (elt.hasClass(CLASS_COMPLETE)) {
                                $(taskSelectString + ' span.complete').hide()
                            }

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(CLASS_STOPPED);


                        } else if (status == STATUS_RUNNING) {
                            //hide completion message
                            if (elt.hasClass(CLASS_COMPLETE)) {
                                $(taskSelectString + ' span.complete').hide()
                            }

                            // show statusbar
                            if (!(elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED))) {
                                $(taskSelectString + ' span.progressbar').show();
                            }
                            
                            // expand tree if needed
                            if (elt.hasClass('collapsed')) {
                                elt.toggle();
                            }
                            
                            //update progressbar
                            $(taskSelectString + ' .progressbar').progressBar(progress);
                            
                            //set status
                            removeAllStatus(elt);
                            elt.addClass(CLASS_RUNNING);

                        } else if (status == STATUS_PAUSED) {
                            // show statusbar
                            if (!(elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED))) {
                                $(taskSelectString + ' span.progressbar').show();
                            }

                            //hide completion message
                            if (id.hasClass(CLASS_RUNNING) || id.hasClass(CLASS_PAUSED)) {
                                $(taskSelectString + ' span.complete').hide()
                            }

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(STATUS_PAUSED);

                        } else if (status == STATUS_COMPLETE && !elt.hasClass(CLASS_COMPLETE)) {
                            // hide statusbar
                            if (elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED)) {
                                bar = $(taskSelectString + ' span.progressbar')
                                bar.hide();
                                bar.progressBar(0);
                            }

                            //show completion message
                            $(taskSelectString + ' span.complete').show()

                            // collapse tree if needed
                            if (elt.hasClass('expanded')) {
                                elt.toggle();
                            }

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(CLASS_COMPLETE);

                        } else if (status == STATUS_FAILED) {

                        }
                    }
               }
            }

            function update() {
                $.post('progress/',{},processProgressData);
                setTimeout('update()', 2000);
            }

        </script>
        <link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}jquery.acts_as_tree_table.css" />
        <style>
            * { font-family: Helvetica, Arial, Tahoma; font-size: 12px; font-color: #444; line-height: 25px; padding: 0px; margin: 0px; }
            div.tasks {padding-left:20px; margin-left:20px;}
            td {padding-left:10px; min-width:50px;}
            span.complete{
                    background-image: url({{MEDIA_URL}}/images/check.png);
                    background-position: left center;
                    background-repeat: no-repeat;
                    cursor: pointer;
                    padding: 0;
                    zoom: 1; /* Hack for IE, works in IE7, I refuse to check in IE6 or older */
                    width:50px;
                    padding:20px;
                }

            div.topleveltask{
                border: 1px;
                border-style: solid;
                margin-bottom: 10px;
                padding-left:20px;
                width: 80%;
            }
            
            span.lastrun {
                float:right;
                margin-right:10px;
            }
            
            span.label {
                font-weight:700;
            }
            
            body {
                padding:30px;
            }
            
            div.tasks {
                margin-top:30px;
            }
        </style>
    </head>
    <body>

        <h1>Test Page for Task Management</h1>
        
        Admin page for monitoring and testing long running maintenence tasks required for your django app.  It supports multiple users whom will all see the same status for the task.
        
        This example task just prints some statements out to the console and sleeps.
        <br/>
        <br/>
        <h3>Instructions:</h3>
       
        <ol>
        <li> Press Update to begin ajax updates.  For now i dont want a barrage of ajax requests</li>
        <li> Press Start to start process,  if its not already running
        </ol>

        <br/>
        <h3>How It works</h3>
        Django is opening a socket to a TaskManagement server for each mod_python subinterpreter.  The server is multithreaded to accomidate multiple clients (apache threads) but there is only a single instance of the task being tracked.  Commands and responses are exchanged between django view handlers and the taskserver.  The extra communication adds some overhead but its acceptable for low usage apps.  This also allows the taskserver to be bound to a different processor or another machine.

        <br/>
        <hr/>
        <br/>

<button onclick="update();">1) Start Ajax Update</button>


<div class="tasks">
    {% for key,topleveltask in tasks.items %}
    <div class="topleveltask" id="{{key}}">

        <button class="button-start" >2) Start Task</button>
        <span class="lastrun"><span class="label">Last Run:</span> [value]</span>

        <table id="taskstable-{{key}}" class="taskstable status-stopped">
        {% for task in topleveltask %}
            {% if task.1 %}
                <tr id="task-{{key}}-{{task.0}}" class="child-of-task-{{key}}-{{task.1}}">
            {%else%}
                <tr id="task-{{key}}-{{task.0}}">
            {%endif%}
            <td>{{task.2}}</td><td><span class="complete"></span><span class="progressbar" id="progressbar-{{task.0}}"/></td></tr>
        {% endfor %}
        </table>
        </div>
    {% endfor %}
</div>

        
        

    </body>
</html>
