{% extends 'search_base.html' %}

{% block head %}
        <style>
            #content {
                margin-left:auto;
                margin-right:auto;
                width:530px;
                min-width:530px;
            }

            #canvas_container {
                height: 472px;
                margin: 15px;
                margin-left:auto;
                margin-right:auto
                min-height:472px;
                width: 500px;
            }

            #canvas {
                margin-left:auto;
                margin-right:auto;
                width: 471px;
                height: 100%;
            }

            #ajax_progress {
                padding-top:10%;
                width: 100%;
                height: 90%;
                text-align:center;
            }

            #ajax_progress div{
                margin-left:auto;
                margin-right:auto;
                width: 350px;
                height: 350px;
                border:1px dotted black;
            }

            #ajax_progress img {
                margin-top:40%;
            }

            #controls {
                margin-top:10px;
                /* Reset alignment to compensate for 'text-align:center': */
                text-align: left;
                /* Specify the width of the element. This should be the same
                    as 'body min-width': */
                width:20em;
                /* Set left and right margins to auto, thus centering the 
                    element in the containing (body) tag: */
                margin-left: auto;
                margin-right: auto;
            }

            #button-plot {
                margin-top:10px;
            }

            input{
                margin-right:10px;
            }

            #binDetails {
                position:absolute;
                top:9em;
                left:30px;
                float:left;
                background-color:grey;
                font-size:10;
                color:white;
                border: 1px solid #aaaaaa;
                line-height:10px;
            }

            #binDetails td {
                color:black;
                line-height:1em;
                padding:.5em;
                margin:3px;
                width:6em;
            }

            #binDetails table {
                margin: 0px;
                background-color:grey;
                border: 2px solid black;
                width:20em;
            }

            td {
                white-space : nowrap;
            }

            .label {
                margin-right:10px;
                margin-left:10px;
                font-weight:bold;
            }

            .col2 {
                margin-left:30px;
            }

            .field {
                text-align:left;
                margin: 5px;
            }

            #id_attribute, #id_xProperty, #id_yProperty, #id_residue, #id_reference, #id_background_color, #id_hash_color, #id_plot_hue, #id_graph_color, #id_text_color {
                width:7.5em;
            }

            #id_x, #id_y, #id_xBin, #id_height{
                width:3.75em;
                margin-right: 0px;
            }

            #id_x1, #id_y1, #id_yBin, #id_width {
                width:3.75em;
                border-left:0px;
            }

            #buttons {
                text-align:center;
            }

            #advanced {
                border-top: 1px solid black;
                border-left: 1px solid black;
                border-right: 1px solid black;
                border-bottom: 1px solid black;
            }

            .header {
                background-color:#3a76f1;
                color:white;
                font-weight:bold;
                padding-left:10px;
            }
            tr.spacer {
                height:10px;
            }
        </style>

        <script type="text/javascript" src="{{MEDIA_URL}}/js/raphael-min.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/DejaVu_400.font.js"></script>
        <script type="text/javascript">
            var stats = {};
            var aafix = 0.5;
            var boxsizefix = 1;
            var line_x_aafix = 1;
            var line_y_aafix = 0.5;
            var rects_y_aafix = 0;
            var is_IE = false;

            // IE checks - check different things not supported by IE to detect them
            if(!(jQuery.support.objectAll && jQuery.support.leadingWhitespace && jQuery.support.noCloneEvent)){
                is_IE = true;
                boxsizefix = 0;
                line_x_aafix = 2
                line_y_aafix = 2
                rects_y_aafix = 0.5;
            }

            var stat_field = false;

            $(document).ready(function() {
                $('div#binDetails').hide();

                $('#button-plot').click(function (evt) {
                    update_svg();
                });
                $('#button-save').click(function (evt) {
                    $("form").attr('action','{{SITE_ROOT}}search/plot/png/').submit().attr('action','{{SITE_ROOT}}search/plot/svg/')
                });

                $('#button-data').click(function (evt) {
                    $("form").attr('action','{{SITE_ROOT}}search/plot/dump/').submit().attr('action','{{SITE_ROOT}}search/plot/svg/')
                });

                $('#id_xProperty').change(function (){
                        $('#id_xProperty option:selected').each(function () {
                            _default = DEFAULTS[$(this).val()];
                            $('#id_x').val(_default['min']);
                            $('#id_x1').val(_default['max']);
                            $('#id_xBin').val(_default['stepsize']);
                        });
                });

                $('#id_yProperty').change(function (){
                        $('#id_yProperty option:selected').each(function () {
                            //_default = DEFAULTS[$(this).val()];
                            $('#id_y').val(_default['min']);
                            $('#id_y1').val(_default['max']);
                            $('#id_yBin').val(_default['stepsize']);
                        });
                });

                $('#advanced').hide()
                $('#advanced_toggle').click(function(){
                    $('#advanced').toggle();
                    if ($(this).html()=='Colors/Dimensions &gt;&gt;') {
                        $(this).html('Colors/Dimensions &lt;&lt;');
                    }else{
                        $(this).html('Colors/Dimensions &gt;&gt;');
                    }
                })

                update_svg();
            });

            var DEFAULTS =  {% autoescape off %}{{defaults}}{% endautoescape %};

            /*
               process form data and submit via ajax
            */
            function update_svg() {
                // gather data from form
                $form = $('#plotform');
                $inputs = $form.find(' input, select');
                    args = {};
                    for (i=0; i<$inputs.length; i++) {
                        input = $inputs.get(i);
                        args[input.id.slice(3)]= $(input).val();
                    }

                // update statfield so details renders correctly
                stat_field = ($('#id_attribute').val() != 'Observations');

                //clear errors and graph
                $('#errors').empty();

                //clear graph
                $('#canvas')
                    .hide()
                    .empty()
                    .removeClass('hasSVG');
                $('#ajax_progress').show();

                // submit
                $.post('{{SITE_ROOT}}search/plot/svg/render/',args, process_svg_data, "json");
            }

            function process_svg_data(data) {
                if (data['errors'] != undefined) {
                    process_form_errors(data['errors']);
                    return;
                }

                // deactivate spinner
                $('#ajax_progress').hide();
                $('#canvas').show();

                // process graph
                var paper = Raphael("canvas", 700, 700);

                rects = data['background']['rects']
                for (i in rects) {
                    rect = rects[i]
                    r = paper.rect(rect['x']+aafix,
                        rect['y']+aafix,
                        rect['height'],
                        rect['width']);
                    r.attr({fill: rect['fill'], stroke:rect['color']});
                    r.attr('stroke-width',rect['stroke']);
                }

                lines = data['background']['lines']
                for (i in lines) {
                    line = lines[i];
                    l = paper
                        .path({stroke: line['color']})
                        .moveTo(line['x']+line_x_aafix, line['y']+line_y_aafix)
                        .lineTo(line['x1']+line_x_aafix, line['y1']+line_y_aafix);
                }

                texts = data['background']['texts'];
                font = paper.getFont("DejaVu");
                //font = paper.getFont("DoulosSIL");

                for (i in texts) {
                    text = texts[i]
                    paper.print(text['x'],text['y'],text['text'], font,12);
                }

                stats = {};
                boxes = data['boxes'];
                for (i in boxes) {
                    rect = boxes[i];
                    r = paper.rect(rect[0]+aafix,
                        rect[1]+rects_y_aafix,
                        rect[2]+boxsizefix,
                        rect[3]+boxsizefix);
                    r.attr({fill: "#" +rect[4], stroke:"#" +rect[4]});
                    r.attr('stroke-width',0);


                    r[0].onmouseover = function(){
                        if (is_IE) {
                            bin_mouseover(this.id);
                        } else {
                            bin_mouseover(this.getAttribute('x')+'-'+this.getAttribute('y'));
                        }
                    };

                    //add static fields
                    if (is_IE){
                        key = rect[0]+'-'+rect[1];
                        r[0].id = key;
                    } else {
                        key = r[0].getAttribute('x')+'-'+r[0].getAttribute('y');
                    }

                    stats[key] = {
                        'observations':rect[6]['count'],
                        'bin': [rect[7][0],rect[7][1]],
                        'avg': rect[8],
                        'dev': rect[9]
                    };
                }
            }

            function process_form_errors(errors) {
                $errors = $('#errors')

                // clear existing errors
                $errors.empty();

                for (key in errors) {
                    error = errors[key]
                    html = "<li><strong>"+ error[0] + " - </strong>" + error[1] + "</li>";
                    $errors.append(html);
                }
            }

            function bin_mouseover(val){
                field_stats = stats[val];

                // set static properties
                $('#stat_xattribute td.x').html(""+(field_stats['bin'][0]*{{xBin}}))
                $('#stat_xattribute td.y').html(""+(field_stats['bin'][0]*{{xBin}}+{{xBin}}))
                $('#stat_yattribute td.x').html(""+(field_stats['bin'][1]*{{yBin}}))
                $('#stat_yattribute td.y').html(""+(field_stats['bin'][1]*{{yBin}}+{{yBin}}))
                $('#stat_bin td.x').html(""+field_stats['bin'][0])
                $('#stat_bin td.y').html(""+field_stats['bin'][1])
                $('#stat_observations').html(field_stats['observations'])
                $('#stat_field td.avg').html(field_stats['avg']);
                $('#stat_field td.dev').html(field_stats['dev']);

                //show the divs
                if (stat_field){
                    $('#stat_field').show();
                } else {
                    $('#stat_field').hide();
                }
                $('div#binDetails').show();
            }

            function bin_mouseout(){
                $('div#binDetails').hide();
            }
        </script>
{% endblock %}
{% block content %}
    <div id="canvas_container">
        <div id="ajax_progress">
            <div>
            <img src="{{MEDIA_URL}}/images/ajax-loader.gif"/>
            <h1>Generating Plot</h1>
            </div>
        </div>
        <div id="canvas"></div>
    </div>

    <ul id="errors"></ul>
    <div id="buttons">
        <button id="button-plot">Re-Plot</button>
        <button id="button-save">Save Plot Image</button>
        <button id="button-data">Save Plot Data</button>
    </div>
    <form id="plotform" name="plot" method="post">
        <table id="controls">
            <tbody>
            <tr><td class="header" colspan="100%">General</td></tr>
            <tr>
                <td class="label">Plotted Attribute</td>
                {% autoescape off %}
                <td>{{form.attribute}}</td>
                {% endautoescape %}
                <td class="label col2">Reference</td>
                <td>{{form.reference}}</td>
            </tr>
            <tr>
                <td class="label">X Axis</td>
                <td>{{form.xProperty}}</td>
                <td class="label col2">X Min, Max</td>
                <td>{{form.x}}{{form.x1}}</td>
            </tr>
            <tr>
                <td class="label">Y Axis</td>
                <td>{{form.yProperty}}</td>
                <td class="label col2">Y Min, Max</td>
                <td>{{form.y}}{{form.y1}}</td>
            </tr>
            <tr>
                <td class="label">Residue</td>
                <td>{{form.residue}}</td>
                <td class="label col2">Bin X, Y</td>
                <td>{{form.xBin}}{{form.yBin}}</td>
            </tr>

        </tbody>

        <tr class="spacer"/>
        <tr><td id="advanced_toggle" class="header" colspan="100%">Colors/Dimensions &gt;&gt;</td></tr>
        <tbody id="advanced">
                <tr>
                    <td class="label">Image Background</td>
                    <td>{{form.background_color}}</td>
                    <td class="label">Graph Background</td>
                    <td>{{form.graph_color}}</td>
                </tr>
                <tr>
                    <td class="label">Text Color</td>
                    <td>{{form.text_color}}</td>
                    <td class="label">Bin Shading</td>
                    <td>{{form.plot_hue}}</td>
                </tr>
                <tr>
                    <td class="label">Height/Width</td>
                    <td>{{form.height}}{{form.width}}</td>
                    <td class="label">Hash Color</td>
                    <td>{{form.hash_color}}</td>
                </tr>
                </tbody>
        </table>
    </form>
    <div id="binDetails">
        <table>
            <tr id="stat_xattribute"><td class="label">{{xProperty}}:</td><td class="x"></td><td class="y"></td></tr>
            <tr id="stat_yattribute"><td class="label">{{yProperty}}:</td><td class="x"></td><td class="y"></td></tr>
            <tr><td class="label">Observations</td><td id="stat_observations"></td></tr>
            <tr id="stat_field"><td class="label">Avg {{stat_field|capfirst}}:</td><td class="avg"></td><td class="dev"></td></tr>
            <tr id="stat_bin"><td class="label">Bin:</td><td class="x"></td><td class="y"></td></tr>
        </table>
    </div>
{% endblock %}
