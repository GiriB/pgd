{% extends 'search_base.html' %}

{% block head %}
        <style>
            #content {
                margin-left:auto;
                margin-right:auto;
                width:730px;
                min-width:530px;
            }

            #canvas_container {
                height: 472px;
                margin: 15px;
                margin-left:auto;
                margin-right:auto;
                min-height:472px;
                width: 650px;
            }

            #canvas {
                margin-left:auto;
                margin-right:auto;
                width: 560px;
                height: 100%;
            }

            #ajax_progress {
                padding-top:10%;
                width: 100%;
                height: 90%;
                text-align:center;
            }

            #ajax_progress div{
                margin-left:auto;
                margin-right:auto;
                width: 350px;
                height: 350px;
                border:1px dotted black;
            }

            #ajax_progress img {
                margin-top:40%;
            }

            #controls {
                margin-top:10px;
                /* Reset alignment to compensate for 'text-align:center': */
                text-align: left;
                /* Specify the width of the element. This should be the same
                    as 'body min-width': */
                width:20em;
                /* Set left and right margins to auto, thus centering the 
                    element in the containing (body) tag: */
                margin-left: auto;
                margin-right: auto;
            }

            #button-plot {
                margin-top:15px;
            }

            input {
                margin-right:10px;
                height:1.71em;
                padding-top:.5em;
                line-height:2.15em;
            }

            #binDetails {
                position:absolute;
                top:9em;
                left:30px;
                float:left;
                background-color:grey;
                font-size:10;
                color:white;
                border: 1px solid #aaaaaa;
                line-height:10px;
            }

            #binDetails td {
                color:black;
                line-height:1em;
                padding:.5em;
                margin:3px;
                width:6em;
            }

            td.dev, td.y {
                padding-left:20px;
            }

            #binDetails table {
                margin: 0px;
                background-color:grey;
                border: 2px solid black;
                width:20em;
            }

            td {
                white-space : nowrap;
            }

            .label {
                margin-right:10px;
                margin-left:10px;
                font-weight:bold;
                text-align:left;
                padding-right: 10px;
            }

            .col2 {
                margin-left:30px;
            }

            .field {
                text-align:left;
                margin: 5px;
            }

            #id_attribute, #id_xProperty, #id_yProperty, #id_residue, #id_reference, #id_background_color, #id_hash_color, #id_plot_hue, #id_graph_color, #id_text_color {
                width:7.5em;
            }

            #id_x, #id_y, #id_xBin, #id_height{
                width:3.75em;
                margin-right: 0px;
            }

            #id_x1, #id_y1, #id_yBin, #id_width {
                width:3.75em;
                border-left:0px;
            }

            #buttons {
                text-align:center;
            }

            #advanced {
                border-top: 1px solid black;
                border-left: 1px solid black;
                border-right: 1px solid black;
                border-bottom: 1px solid black;
            }

            .header {
                background-color:#3a76f1;
                color:white;
                font-weight:bold;
                padding-left:10px;
            }
            tr.spacer {
                height:10px;
            }

            /*==================================
            remove default focus style
            ====================================*/
            :focus {outline:none;}
            .js ul.newList {left:-9999px;}

            /*======================================
            windows xp style - div that contains the 
            <select> has been given an id of 
            (for the purposes of this example
            ========================================*/
             .newListSelected {
                background:#FFF url({{MEDIA_URL}}/images/dropdown.gif) no-repeat scroll 155px 1px; 
                border:1px solid #d4d4d4;
                color:#000;
                height:2.21em;
                padding:0;
                width:7.5em;
                }
             .newListSelected div {
                display:block;
                font-size:.85em;
                line-height:2.2em;
                padding-left:3px;
                text-align:left !important;
                width:7.5em;
                }
             ul.newList {
                background:#fff;
                border:6px solid #999999;
                color:#000;
                font-size: 0.85em;
                height:auto;
                left:0;
                list-style:none;
                overflow:auto;
                position:absolute;
                text-align:left !important;
                top:22px;
                width:8em;
                z-index:9999;
                }
             ul.newList li {
                border-bottom: 1px solid #cccccc;
                height:2em;
                line-height:1em;
                padding-left:5px;
                padding-right:5px;
                }
             .hiLite {background:#316ac5!important; color:#fff!important;}
             .newListHover {background:#ccc!important; color:#000!important; cursor:default;}
             .newListSelHover {cursor:default;}
             .newListSelHover,  .newListSelFocus {background-position:auto;}
             div.selectedTxt {
                width:8.75em;
                height:100%;
             }
        </style>

        <script type="text/javascript" src="{{MEDIA_URL}}/js/jqbrowser.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.stylish-select.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/raphael-min.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.qtip-1.0.0-rc3.min.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/DejaVu_400.font.full.js"></script>
        <script type="text/javascript">
            var stats = {};
            var aafix = 0.5;
            var rects_width_fix = 1;
            var rects_height_fix = 1;
            var line_x_aafix = 0;
            var line_y_aafix = 0.5;
            var rects_x_aafix = -.5
            var rects_y_aafix = 0;
            var is_IE = false;
            var contentText = 'Mouse over a bin in the plot to see the relevent data.';
            var xBin = {{xBin}};
            var yBin = {{yBin}};

            // IE checks - check different things not supported by IE to detect them
            if($.jqbrowser.msie()){
                is_IE = true;
                rects_width_fix = 0;
                rects_height_fix = 0;
                line_x_aafix = 2
                line_y_aafix = 2
                rects_x_aafix = 0.5;
                rects_y_aafix = 0.5;
            } else if ($.jqbrowser.win()) {
                aafix = 0;
                rects_x_aafix = -1
                rects_y_aafix = -.5
                line_x_aafix = -.5;
                line_y_aafix = 0;
                rects_width_fix = 1.5
            }

            var stat_field = false;

            $(document).ready(function(){
                $('div#binDetails').hide();
                $('#canvas_container').qtip({
                        position:{
                            adjust: { //Make the tooltip avoid going outside the window due to browser resizing
                                    resize: true
                                    },
                            corner: {
                                    target: 'leftTop',
                                    tooltip: 'rightTop'
                                    },
                            target:$('#canvas_container')
                                 },
                        style:{ //Style the qtip to look like the page
                              color: 'black',
                              textAlign: 'center',
                              title: { color: 'white', background: '#666666'},
                              width: { min: 240, max: 440 },
                              border:{ 
                                     width: 6, 
                                     color: '#909090'
                                     }
                               },
                        show: false,
                        hide: false,
                        content:{
                                prerender: false,//This kills pageload times if enabled
                                text: contentText,
                                title:  {
                                        text: 'Bin Details'
                                        }
                                }
                            }); 
                $('#canvas_container').qtip('show');
                $('#button-plot').click(function (evt) {
                    xBin = $('input#id_xBin').attr('value');
                    yBin = $('input#id_yBin').attr('value');
              //      xProperty = $('#id_xProperty').html();
              //      yProperty = $('#id_yProperty').html();
              //      $('#x_property_label').html(xProperty);
              //      $('#y_property_label').html(yProperty);
                    xBin=parseInt(xBin);
                    yBin=parseInt(yBin);
                    update_svg();
                });

                $('select').sSelect();

                $('#button-save').click(function (evt) {
                    $("form").attr('action','{{SITE_ROOT}}search/plot/png/').submit().attr('action','{{SITE_ROOT}}search/plot/svg/')
                });

                $('#button-data').click(function (evt) {
                    $("form").attr('action','{{SITE_ROOT}}search/plot/dump/').submit().attr('action','{{SITE_ROOT}}search/plot/svg/')
                });

                $('#id_xProperty').change(function (){
                        $('#id_xProperty option:selected').each(function () {
                            //_default = DEFAULTS[$(this).val()];
                            //$('#id_x').val(_default['min']);
                            //$('#id_x1').val(_default['max']);
                            //$('#id_xBin').val(_default['stepsize']);
                        });
                });

                $('#id_yProperty').change(function (){
                        $('#id_yProperty option:selected').each(function () {
                            //_default = DEFAULTS[$(this).val()];
                            //$('#id_y').val(_default['min']);
                            //$('#id_y1').val(_default['max']);
                            //$('#id_yBin').val(_default['stepsize']);
                        });
                });

            if ($('#id_attribute :selected').text()=='Observations') {
                            $('#residue_attribute').css({'visibility': 'hidden'})
                        }
                $('#id_attribute').change(function (){
            if ($('#id_attribute :selected').text()=='Observations') {
                            $('#residue_attribute').css({'visibility': 'hidden'})
                        }else{
                            $('#residue_attribute').css({'visibility': 'visible'})
                        }
                })

                $('#extra').hide()
                $('#extra_toggle').click(function(){
                    $('#extra').toggle();
                    if ($(this).html()=='Extra Options &gt;&gt;') {
                        $(this).html('Extra Options &lt;&lt;');
                    }else{
                        $(this).html('Extra Options &gt;&gt;');
                    }
                })

                $('#advanced').hide()
                $('#advanced_toggle').click(function(){
                    $('#advanced').toggle();
                    if ($(this).html()=='Colors/Dimensions &gt;&gt;') {
                        $(this).html('Colors/Dimensions &lt;&lt;');
                    }else{
                        $(this).html('Colors/Dimensions &gt;&gt;');
                    }
                })


                // Explicitly select x and y defaults.  the stylish select
                // does not work when the select box contains a special character
                // it will instead select the first item in the list
                $('#id_xProperty option').each(function() {
                    if (this.value == 'phi') {
                        this.selected = true;
                    } else {
                        this.selected = false;
                    }
                });

                $(' #id_yProperty option').each(function() {
                    if (this.value == 'psi') {
                        this.selected = true;
                    } else {
                        this.selected = false;
                    }
                });

                update_svg();

            });

            var DEFAULTS =  {% autoescape off %}{{defaults}}{% endautoescape %};

            /*
               process form data and submit via ajax
            */
            function update_svg() {
                // gather data from form
                $form = $('#plotform');
                $inputs = $form.find(' input, select');
                    args = {};
                    for (i=0; i<$inputs.length; i++) {
                        input = $inputs.get(i);
                        args[input.id.slice(3)]= $(input).val();
                    }

                // update statfield so details renders correctly
                stat_field = ($('#id_attribute').val() != 'Observations');

                //clear errors and graph
                $('#errors').empty();

                //clear graph
                $('#canvas')
                    .hide()
                    .empty()
                    .removeClass('hasSVG');
                $('#ajax_progress').show();

                // submit
                $.post('{{SITE_ROOT}}search/plot/svg/render/',args, process_svg_data, "json");
            }

            function process_svg_data(data) {
                if (data['errors'] != undefined) {
                    process_form_errors(data['errors']);
                    return;
                }

                // deactivate spinner
                $('#ajax_progress').hide();
                $('#canvas').show();

                // process graph
                var paper = Raphael("canvas", 700, 472);

                rects = data['background']['rects']
                for (i=0; i<rects.length; i++) {
                    rect = rects[i]
                    r = paper.rect(rect['x']+aafix,
                        rect['y']+aafix,
                        rect['width']-.5,
                        rect['height']);
                    r.attr({fill: rect['fill'], stroke:rect['color']});
                    r.attr('stroke-width',rect['stroke']);
                }

                texts = data['background']['texts'];
                font = paper.getFont("DejaVu");
                //font = paper.getFont("DoulosSIL");

                for (i in texts) {
                    text = texts[i]
                    paper.print(text['x'],text['y'],text['text'], font, text['size']);
                }

                stats = {};
                boxes = data['boxes'];
                for (i=0; i<boxes.length; i++) {
                    rect = boxes[i];
                    r = paper.rect(rect[0]+rects_x_aafix,
                        rect[1]+rects_y_aafix,
                        rect[2]+rects_width_fix,
                        rect[3]+rects_height_fix);
                    r.attr({fill: "#" +rect[4], stroke:"#" +rect[4]});
                    r.attr('stroke-width',0);

                    r[0].onmouseover = function(){
                        if (is_IE) {
                            bin_mouseover(this.id);
                        } else {
                            bin_mouseover(this.getAttribute('x')+'-'+this.getAttribute('y'));
                        }
                    };

                    //add static fields
                    if (is_IE){
                        key = rect[0]+'-'+rect[1];
                        r[0].id = key;
                    } else {
                        key = r[0].getAttribute('x')+'-'+r[0].getAttribute('y');
                    }

                    stats[key] = {
                        'observations':rect[6],
                        'bin': [rect[7][0],rect[7][1]],
                        'avg': rect[8].toFixed(3),
                        'dev': rect[9].toFixed(3)
                    };
                }

                lines = data['background']['lines']
                for (i in lines) {
                    line = lines[i];
                    l = paper
                        .path({stroke: line['color']})
                        .moveTo(line['x']+line_x_aafix, line['y']+line_y_aafix)
                        .lineTo(line['x1']+line_x_aafix, line['y1']+line_y_aafix);
                }

            }

            function process_form_errors(errors) {
                $errors = $('#errors')

                // clear existing errors
                $errors.empty();

                for (key in errors) {
                    error = errors[key]
                    html = "<li><strong>"+ error[0] + " - </strong>" + error[1] + "</li>";
                    $errors.append(html);
                }
            }

            function bin_mouseover(val){
                field_stats = stats[val];

                // set static properties
                $('#stat_xattribute td.x').html(""+(field_stats['bin'][0]*xBin));
                $('#stat_xattribute td.y').html(""+(field_stats['bin'][0]*xBin+xBin));
                $('#stat_yattribute td.x').html(""+(field_stats['bin'][1]*yBin));
                $('#stat_yattribute td.y').html(""+(field_stats['bin'][1]*yBin+yBin));
                $('#stat_observations').html(field_stats['observations']);
                $('#stat_field td.avg').html(field_stats['avg']);
                $('#stat_field td.dev').html(field_stats['dev']);

                contentText=$('div#binDetails').html();
                $('div.qtip').qtip('api').updateContent(contentText);
            }

            function bin_mouseout(){
                $('div#binDetails').hide();
            }
        </script>
{% endblock %}
{% block content %}
    <div id="canvas_container">
        <div id="ajax_progress">
            <div>
            <img src="{{MEDIA_URL}}/images/ajax-loader.gif"/>
            <h1>Generating Plot</h1>
            </div>
        </div>
        <div id="canvas"></div>
    </div>

    <ul id="errors"></ul>
    <div id="buttons">
        <button id="button-plot">Re-Plot</button>
        <button id="button-save">Save Plot Image</button>
        <button id="button-data">Save Plot Data</button>
    </div>
    <form id="plotform" name="plot" method="post">
        <table id="controls">
            <tbody>
            <tr><td class="header" colspan="100%">General</td></tr>
            <tr>
                <td class="label">Plotted Attribute</td>
                {% autoescape off %}
                <td id="attribute">{{form.attribute}}</td>
                <td id="residue_attribute">{{form.residue_attribute}}</td>
                {% endautoescape %}
                <td class="label col2">Bin X, Y</td>
                <td>{{form.xBin}}{{form.yBin}}</td>
            </tr>
            <tr>
                <td class="label">X Axis</td>
                {% autoescape off %}
                <td>{{form.xProperty}}</td>
                <td>{{form.residue_xproperty}}</td>
                {% endautoescape %}
                <td class="label col2">X Min, Max</td>
                <td>{{form.x}}{{form.x1}}</td>
            </tr>
            <tr>
                <td class="label">Y Axis</td>
                {% autoescape off %}
                <td>{{form.yProperty}}</td>
                <td>{{form.residue_yproperty}}</td>
                {% endautoescape %}
                <td class="label col2">Y Min, Max</td>
                <td>{{form.y}}{{form.y1}}</td>
            </tr>
        </tbody>

                <tr class="spacer"/>
                <tr><td id="extra_toggle" class="header" colspan="100%">Extra Options &gt;&gt;</td></tr>
                <tbody id="extra">
                    <tr>
                        <td class="label col2">Reference</td>
                        <td>{{form.reference}}</td>
			
			<td class="label col2">Sigma Value</td>
                        <td>{{form.sigmaVal}}</td>
                    </tr>
                </tbody>


        <tr class="spacer"/>
        <tr><td id="advanced_toggle" class="header" colspan="100%">Colors/Dimensions &gt;&gt;</td></tr>
        <tbody id="advanced">
                <tr>
                    <td class="label">Image Background</td>
                    <td>{{form.background_color}}</td>
                    <td class="label">Graph Background</td>
                    <td>{{form.graph_color}}</td>
                </tr>
                <tr>
                    <td class="label">Text Color</td>
                    <td>{{form.text_color}}</td>
                    <td class="label">Bin Shading</td>
                    <td>{{form.plot_hue}}</td>
                </tr>
                <tr>
                    <td class="label">Height/Width</td>
                    <td>{{form.height}}{{form.width}}</td>
                    <td class="label">Hash Color</td>
                    <td>{{form.hash_color}}</td>
                </tr>
                </tbody>
        </table>
    </form>
    <div id="binDetails">
        <table>
            <tr id="stat_xattribute"><td id="x_property_label" class="label">{{xProperty}}:</td><td class="x"></td><td class="y"></td></tr>
            <tr id="stat_yattribute"><td id="y_property_label" class="label">{{yProperty}}:</td><td class="x"></td><td class="y"></td></tr>
            <tr><td class="label">Observations:</td><td id="stat_observations"></td></tr>
            <tr id="stat_field"><td class="label">Avg{{stat_field|capfirst}}:</td><td class="avg"></td><td class="dev"></td></tr>
        </table>
    </div>
{% endblock %}
