<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">

<html>
    <head>
        <style type="text/css">@import "{{MEDIA_URL}}/css/jquery.svg.css";</style> 
        <style>
            #canvas {
                width: 472px;
                height: 472px;
                margin: 5px;
            }

            #controls {
                margin-top:10px;
                /* Reset alignment to compensate for 'text-align:center': */
                text-align: left;
                /* Specify the width of the element. This should be the same
                    as 'body min-width': */
                width:20em;
                /* Set left and right margins to auto, thus centering the 
                    element in the containing (body) tag: */
                margin-left: auto;
                margin-right: auto;
            }

            #button-plot {
                margin-top:10px;
            }

            input{
                margin-right:10px;
            }

            #binDetails {
                position:absolute;
                top:9em;
                left:30px;
                float:left;
                background-color:grey;
                font-size:10;
                color:white;
                border: 1px solid #aaaaaa;
                line-height:10px;
            }

            #binDetails td {
                line-height:1em;
                padding:.5em;
                margin:3px;
                width:6em;
            }

            #binDetails table {
                margin: 0px;
                border: 2px solid black;
                width:20em;
            }

            td {
                white-space : nowrap;
            }

            .label {
                margin-right:10px;
                margin-left:10px;
                font-weight:bold;
            }

            .col2 {
                margin-left:30px;
            }

            .field {
                text-align:left;
                margin: 5px;
            }

            #id_attribute, #id_xProperty, #id_yProperty, #id_residue, #id_reference, #id_background_color, #id_hash_color, #id_plot_hue, #id_graph_color, #id_text_color {
                width:7.5em;
            }

            #id_x, #id_y, #id_xBin, #id_height{
                width:3.75em;
                margin-right: 0px;
            }

            #id_x1, #id_y1, #id_yBin, #id_width {
                width:3.75em;
                border-left:0px;
            }

            #buttons {
                text-align:center;
            }

            #advanced {
                border-top: 1px solid black;
                border-left: 1px solid black;
                border-right: 1px solid black;
                border-bottom: 1px solid black;
            }

            .header {
                background-color:#3a76f1;
                color:white;
                font-weight:bold;
                padding-left:10px;
            }
            tr.spacer {
                height:10px;
            }
        </style>

        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery-1.2.6.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.svg.js"></script>

        <script type="text/javascript">
            var stats = {};

            $(document).ready(function() {
                $('div#binDetails').hide();
                $('#canvas').svg()

                fix = 0.5;
                x = 100;
                y = 100;
                height = 400;
                width = 400;
                borderPadding = 40;
                var svg = $('#canvas').svg('get');
                {% for rect in svg.rects %}
                    svg.rect(
                        {{rect.x}}+fix,
                        {{rect.y}}+fix,
                        {{rect.height}},
                        {{rect.width}},
                        {fill: '{{rect.fill}}', stroke:  "{{rect.stroke}}", 'stroke-width':{{rect.stroke}}}
                    );
                {% endfor %}

                {% for line in svg.lines %}
                    svg.line(
                        {{line.x}}+fix,
                        {{line.y}}+fix,
                        {{line.x1}}+fix,
                        {{line.y1}}+fix,
                        {stroke: '{{line.color}}', 'stroke-width': {{line.stroke}}}
                    );
                {% endfor %}

                {% for text in svg.texts %}
                    svg.text(
                        {{text.x}},
                        {{text.y}},
                        '{{text.text}}',
                        {'font-family': "{{text.fontfamily}}", 'font-size': "{{text.size}}", fill: "{{text.color}}"}
                    );
                {% endfor %}

                {% for rect in boxes %}
                    svg.rect(
                        {{rect.0}}+fix,
                        {{rect.1}}+fix,
                        {{rect.2}},
                        {{rect.3}},
                        {fill: '#{{rect.4}}', stroke: '#{{rect.4}}', 'stroke-width': 1, onmouseover:'bin_mouseover(evt, "{{rect.7.0}}-{{rect.7.1}}");', onmouseout:'bin_mouseout();'}
                    );

                    //add static fields
                    field_stats = {'observations':{{rect.6.count}} };
                    field_stats['bin'] = [{{rect.7.0}},{{rect.7.1}}];
                    field_stats['avg'] = '{{rect.8|floatformat:3}}';
                    field_stats['dev'] = '({{rect.9|floatformat:3}})';

                    // add to main dict
                    stats['{{rect.7.0}}-{{rect.7.1}}'] = field_stats

                {% endfor %}

                $('#button-plot').click(function (evt) {
                    $("form").submit();
                });
                $('#button-save').click(function (evt) {
                    $("form").attr('action','{{SITE_ROOT}}search/plot/png/').submit().attr('action','{{SITE_ROOT}}search/plot/svg/')
                });

                $('#button-data').click(function (evt) {
                    $("form").attr('action','{{SITE_ROOT}}search/plot/dump/').submit().attr('action','{{SITE_ROOT}}search/plot/svg/')
                });

                $('#id_attribute').change(function (){
                        $('#id_attribute option:selected').each(function () {
                        $('#id_reference').val(REF[$(this).text()]['ref']);
                        });
                })
                $('#advanced').hide()
                $('#advanced_toggle').click(function(){
                    $('#advanced').toggle();
                    if ($(this).html()=='Colors/Dimensions &gt;&gt;') {
                        $(this).html('Colors/Dimensions &lt;&lt;');
                    }else{
                        $(this).html('Colors/Dimensions &gt;&gt;');
                    }
                })

            });

            var REF = {};
            REF['Observations'] = {'ref':'','stepsize':''}
            {% for k,v in referenceValues.items %}
                {% ifnotequal k 'Observations' %}
                    REF['{{k}}'] = {'ref':{{v.ref}},'stepsize':{{v.stepsize}}}
                {% endifnotequal %}
            {% endfor %}

            function bin_mouseover(evt, val){
                field_stats = stats[val]

                // set static properties
                $('#stat_xattribute td.x').html(""+(field_stats['bin'][0]*{{xBin}}))
                $('#stat_xattribute td.y').html(""+(field_stats['bin'][0]*{{xBin}}+{{xBin}}))
                $('#stat_yattribute td.x').html(""+(field_stats['bin'][1]*{{yBin}}))
                $('#stat_yattribute td.y').html(""+(field_stats['bin'][1]*{{yBin}}+{{yBin}}))
                $('#stat_bin td.x').html(""+field_stats['bin'][0])
                $('#stat_bin td.y').html(""+field_stats['bin'][1])
                $('#stat_observations').html(field_stats['observations'])
                $('#stat_field td.avg').html(field_stats['avg']);
                $('#stat_field td.dev').html(field_stats['dev']);

                //show the div
                $('div#binDetails').show()
            }

            function bin_mouseout(){
                $('div#binDetails').hide();
            }
        </script>
    </head>
    <body>
        {% include 'header.html' %}
        <div id="content">
            <div id="canvas"></div>
            <div id="buttons">
                <button id="button-plot" class="field">Plot</button>
                <button id="button-save">Save</button>
                <button id="button-data">Data</button>
            </div>
            <form id="plotform" name="plot" method="POST" action="{{SITE_ROOT}}search/plot/svg/">
                
                <table id="controls">
                    <tbody>
                    <tr><td class="header" colspan="100%">General</td></tr>
                    <tr>
                        <td class="label">Plotted Attribute</td>
                        <td>{{form.attribute}}</td>
                        <td class="label col2">Reference</td>
                        <td>{{form.reference}}</td>
                    </tr>
                    <tr>
                        <td class="label">X Axis</td>
                        <td>{{form.xProperty}}</td>
                        <td class="label col2">X Min, Max</td>
                        <td>{{form.x}}{{form.x1}}</td>
                    </tr>
                    <tr>
                        <td class="label">Y Axis</td>
                        <td>{{form.yProperty}}</td>
                        <td class="label col2">Y Min, Max</td>
                        <td>{{form.y}}{{form.y1}}</td>
                    </tr>
                    <tr>
                        <td class="label">Residue</td>
                        <td>{{form.residue}}</td>
                        <td class="label col2">Bin X, Y</td>
                        <td>{{form.xBin}}{{form.yBin}}</td>
                    </tr>

                </tbody>

                <tr class="spacer"/>
                <tr><td id="advanced_toggle" class="header" colspan="100%">Colors/Dimensions &gt;&gt;</td></tr>
                <tbody id="advanced">
                        <tr>
                            <td class="label">Image Background</td>
                            <td>{{form.background_color}}</td>
                            <td class="label">Graph Background</td>
                            <td>{{form.graph_color}}</td>
                        </tr>
                        <tr>
                            <td class="label">Text Color</td>
                            <td>{{form.text_color}}</td>
                            <td class="label">Bin Shading</td>
                            <td>{{form.plot_hue}}</td>
                        </tr>
                        <tr>
                            <td class="label">Height/Width</td>
                            <td>{{form.height}}{{form.width}}</td>
                            <td class="label">Hash Color</td>
                            <td>{{form.hash_color}}</td>
                        </tr>
                        </tbody>
                </table>
            </form>
            
        </div>

        <div id="binDetails">
            <table>
                <tr id="stat_xattribute"><td class="label">{{xProperty}}:</td><td class="x"></td><td class="y"></td></tr>
                <tr id="stat_yattribute"><td class="label">{{yProperty}}:</td><td class="x"></td><td class="y"></td></tr>
                <tr><td class="label">Observations</td><td id="stat_observations"></td></tr>
                {% ifnotequal 'Observations' attribute %}
                    <tr id="stat_field"><td class="label">Avg {{stat_field|capfirst}}:</td><td class="avg"></td><td class="dev"></td></tr>
                {% endifnotequal %}
                <tr id="stat_bin"><td class="label">Bin:</td><td class="x"></td><td class="y"></td></tr>
            </table>
        </div>

    </body>
</html>
